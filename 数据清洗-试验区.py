"""
=============================================================================
ä¸»è¦åŠŸèƒ½ï¼š
1. è¯»å–ä¸»è¡¨(1ç»Ÿè®¡æ•°æ®åŒ¹é….xlsx - raw)ä¸æ”¿ç­–è¯•ç‚¹æ±‡æ€»è¾…è¡¨(wash)ã€‚
2. æ•°æ®æ¸…æ´—(æ¨¡ç³ŠåŒ¹é…é”®æ„å»º)ï¼šåˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œå»é™¤ä¸»è¡¨ 'city' åˆ—å’Œè¾…è¡¨ 'åŸå¸‚å' åˆ—ä¸­
   å¸¸è§çš„è¡Œæ”¿åç¼€(å¦‚å¸‚ã€å·ã€è‡ªæ²»å·ã€åœ°åŒºã€ç›Ÿç­‰)ï¼Œç”Ÿæˆç»Ÿä¸€çš„ 'match_key' ä»¥æ¶ˆé™¤å‘½åå·®å¼‚ã€‚
3. æ•°æ®æ¸…æ´—(äºŒå€¼åŒ–)ï¼šéå†7ä¸ªæ”¿ç­–æŒ‡æ ‡åˆ—ï¼Œå°†å€¼ä¸º 0 (æˆ– '0', '0.0') çš„æ•°æ®ä¿ç•™ä¸º 0ï¼Œ
   å°†å…¶ä½™ä»»ä½•éç©ºå€¼ï¼ˆå¦‚ 1, '2015', 'æ˜¯' ç­‰ï¼‰è½¬æ¢ä¸º 1ã€‚
4. æ•°æ®åŒ¹é…ï¼šä»¥ä¸»è¡¨ä¸ºåŸºå‡†(Left Join)ï¼Œä¾æ®å¤„ç†åçš„ 'match_key' å°†æ”¿ç­–è™šæ‹Ÿå˜é‡åˆå¹¶åˆ°ä¸»è¡¨ã€‚
5. ç»“æœä¿å­˜ï¼šå°†åŒ¹é…å¥½çš„æ•°æ®å†™å›åŸå§‹è·¯å¾„çš„Excelæ–‡ä»¶ä¸­ï¼Œè¦†ç›–åŸæœ‰çš„raw sheetã€‚
6. åŒ¹é…æƒ…å†µç»Ÿè®¡ï¼šæ‰“å°æ¨¡ç³ŠåŒ¹é…æˆåŠŸçš„æ•°æ®è¡Œæ•°ä»¥åŠç¼ºå¤±æç¤ºã€‚
=============================================================================
"""

import pandas as pd
import os
import re

def fuzzy_policy_data_matching():
    # ==================== 1. å®šä¹‰æ–‡ä»¶è·¯å¾„ ====================
    main_file = r"D:\1sdgplanning\1data\1ç»Ÿè®¡æ•°æ®åŒ¹é….xlsx"
    policy_file = r"D:\1sdgplanning\1data\ç»Ÿè®¡æ•°æ®é›†\2000-2022å¹´ä¸­å›½å•æ—¶ç‚¹è¯•ç‚¹æ”¿ç­–æ±‡æ€»è¡¨.xlsx"

    # ==================== 2. å®šä¹‰éœ€è¦æå–çš„åˆ— ====================
    policy_cols = [
        'å…¨å›½ç”Ÿæ€ç¤ºèŒƒåŒºå»ºè®¾è¯•ç‚¹åœ°åŒº',
        'å…¨å›½ç”Ÿæ€ç¯å¢ƒç›‘å¯Ÿè¯•ç‚¹åœ°åŒº',
        'å¢ƒå¤–æŠ•èµ„å¤–æ±‡ç®¡ç†æ”¹é©è¯•ç‚¹',
        'å›½å®¶åˆ›æ–°å‹åŸå¸‚',
        'å›½å®¶æ–°å‹åŸé•‡åŒ–',
        'æµ·ç»µåŸå¸‚å»ºè®¾',
        'åŸå¸‚ä¸€åˆ»é’Ÿä¾¿æ°‘ç”Ÿæ´»åœˆ'
    ]
    # è¾…è¡¨ä¸­ä½¿ç”¨ 'åŸå¸‚å' ä½œä¸ºåŒ¹é…åŸºç¡€
    cols_to_load = ['åŸå¸‚å'] + policy_cols

    print("å¼€å§‹åŠ è½½æ•°æ®å¹¶æ„å»ºæ¨¡ç³ŠåŒ¹é…é”®...")
    try:
        # ==================== 3. è¯»å–æ•°æ® ====================
        df_raw = pd.read_excel(main_file, sheet_name="raw")
        df_policy = pd.read_excel(policy_file, sheet_name="wash", usecols=cols_to_load)

        # æ£€æŸ¥ä¸»è¡¨æ˜¯å¦å­˜åœ¨ city åˆ—
        if 'city' not in df_raw.columns:
            raise ValueError("ä¸»è¡¨(raw)ä¸­æœªæ‰¾åˆ°åä¸º 'city' çš„åˆ—ï¼Œè¯·æ ¸å¯¹ã€‚")

        # ==================== 4. æ•°æ®æ¸…æ´— (æ­£åˆ™åŒ–åœ°åç”ŸæˆåŒ¹é…é”®) ====================
        def clean_city_name(name):
            if pd.isna(name):
                return str(name)
            name_str = str(name).strip()
            # åŒ¹é…å¹¶æ›¿æ¢æ‰ç»“å°¾çš„å¸¸è§è¡Œæ”¿åŒºåˆ’åç¼€ï¼Œæ¶µç›–å¸‚ã€å·ã€ä»¥åŠå„ç§è‡ªæ²»å·ç­‰å¤æ‚æƒ…å†µ
            # ä¾‹å¦‚ï¼šé˜¿åè—æ—ç¾Œæ—è‡ªæ²»å· -> é˜¿åè—æ—ç¾Œæ— -> é˜¿å (å¯¹äºç‰¹åˆ«é•¿çš„å°‘æ•°æ°‘æ—è‡ªæ²»å·ï¼Œæœ‰æ—¶è¾…è¡¨åªå†™å‰ä¸¤ä¸ªå­—ï¼Œè¿™é‡Œå°½é‡åˆ‡é™¤åç¼€)
            # æ­£åˆ™è§£é‡Šï¼šåŒ¹é…ç»“å°¾çš„ (å¸‚|å·|åœ°åŒº|ç›Ÿ|æ—åŒº|çŸ¿åŒº|è‡ªæ²»å·|è‡ªæ²»å¿) ç­‰å­—ç¬¦å¹¶æ›¿æ¢ä¸ºç©º
            cleaned_name = re.sub(r'(å¸‚|å·|åœ°åŒº|ç›Ÿ|æ—åŒº|çŸ¿åŒº|è‡ªæ²»å·|è‡ªæ²»å¿|å¿)$', '', name_str)
            
            # é’ˆå¯¹ä¸€äº›è¾…è¡¨å¯èƒ½æŠŠâ€œé˜¿åè—æ—ç¾Œæ—è‡ªæ²»å·â€ç®€å†™ä¸ºâ€œé˜¿åå·â€çš„ç‰¹æ®Šæƒ…å†µå†åšä¸€æ¬¡æ¸…ç†
            cleaned_name = re.sub(r'å·$', '', cleaned_name) 
            return cleaned_name

        # åœ¨ä¸»è¡¨å’Œè¾…è¡¨ä¸­åˆ†åˆ«ç”Ÿæˆç»Ÿä¸€çš„åŒ¹é…é”®
        df_raw['match_key'] = df_raw['city'].apply(clean_city_name)
        df_policy['match_key'] = df_policy['åŸå¸‚å'].apply(clean_city_name)

        # è¾…è¡¨å»é‡ï¼šé˜²æ­¢è¾…è¡¨ä¸­å­˜åœ¨ç›¸åŒçš„ match_key å¯¼è‡´ä¸»è¡¨æ•°æ®è¡Œæ•°è†¨èƒ€
        df_policy.drop_duplicates(subset=['match_key'], keep='first', inplace=True)

        # ==================== 5. æ•°æ®æ¸…æ´— (æŒ‡æ ‡äºŒå€¼åŒ– 0-1 è½¬æ¢) ====================
        def binarize_value(val):
            if pd.isna(val):
                return val
            val_str = str(val).strip()
            if val_str == '0' or val_str == '0.0':
                return 0
            else:
                return 1

        for col in policy_cols:
            df_policy[col] = df_policy[col].apply(binarize_value)

        # ==================== 6. æ•°æ®åˆå¹¶ (Left Join) ====================
        # ä½¿ç”¨ç”Ÿæˆçš„ match_key è¿›è¡Œåˆå¹¶
        df_merged = pd.merge(df_raw, df_policy, on='match_key', how='left')
        
        # åˆå¹¶å®Œæˆåï¼Œåˆ é™¤è¾…åŠ©åŒ¹é…ç”¨çš„ä¸´æ—¶é”®å’Œè¾…è¡¨å¸¦è¿‡æ¥çš„ 'åŸå¸‚å' åˆ—ï¼Œä¿æŒè¡¨æ ¼æ•´æ´
        df_merged.drop(columns=['match_key', 'åŸå¸‚å'], inplace=True, errors='ignore')

        # å¦‚æœä½ éœ€è¦å°†æœªåŒ¹é…åˆ°çš„åŸå¸‚è‡ªåŠ¨å¡«å……ä¸º 0 (è¡¨ç¤ºæ²¡æœ‰è¯•ç‚¹)ï¼Œå¯ä»¥å–æ¶ˆä»¥ä¸‹ä»£ç çš„æ³¨é‡Šï¼š
        # for col in policy_cols:
        #     df_merged[col] = df_merged[col].fillna(0)

        # ==================== 7. è¦†ç›–ä¿å­˜åŸæœ‰Excelæ–‡æ¡£ ====================
        print("\næ­£åœ¨ä¿å­˜å¤„ç†åçš„æ•°æ®åˆ°ä¸»æ–‡ä»¶...")
        with pd.ExcelWriter(main_file, engine='openpyxl', mode='a', if_sheet_exists='replace') as writer:
            df_merged.to_excel(writer, sheet_name='raw', index=False)
        print(f"ä¿å­˜æˆåŠŸï¼æ–‡ä»¶è·¯å¾„: {main_file}")

        # ==================== 8. è¾“å‡ºåŒ¹é…æƒ…å†µæŠ¥å‘Š ====================
        total_rows = len(df_raw)
        matched_count = df_merged[policy_cols[0]].notna().sum()
        
        print("\n" + "="*50)
        print(" åŸºäºåœ°åæ¨¡ç³ŠåŒ¹é…çš„è¯•ç‚¹æ”¿ç­–äºŒå€¼åŒ–æŠ¥å‘Š")
        print("="*50)
        print(f"ä¸»è¡¨(raw)æ€»è¡Œæ•°: {total_rows} è¡Œ")
        print(f"é€šè¿‡[åœ°åæ ¸å¿ƒè¯]æˆåŠŸåŒ¹é…åˆ°æ”¿ç­–è¡¨è®°å½•: {matched_count} è¡Œ (åŒ¹é…ç‡: {matched_count/total_rows:.2%})")
        
        if matched_count < total_rows:
            missing = total_rows - matched_count
            print(f"âš ï¸ æç¤ºï¼šæœ‰ {missing} è¡Œæœªèƒ½é€šè¿‡åŸå¸‚åæ¨¡ç³ŠåŒ¹é…åˆ°æ”¿ç­–æ•°æ®ã€‚")
            
            # ä¸ºäº†æ–¹ä¾¿æ’æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å°å‡ºå‰å‡ ä¸ªæ²¡åŒ¹é…ä¸Šçš„åŸå¸‚å
            unmatched_cities = df_merged[df_merged[policy_cols[0]].isna()]['city'].head(5).tolist()
            if unmatched_cities:
                print(f"ğŸ” æœªåŒ¹é…çš„åŸå¸‚ç¤ºä¾‹: {unmatched_cities} ...ç­‰")
                
            print("ğŸ’¡ å»ºè®®ï¼šå¦‚æœæœªåŒ¹é…ä»£è¡¨æœªå‚ä¸è¯•ç‚¹ï¼Œå¯è§£é™¤ä»£ç ä¸­ df_merged[col].fillna(0) çš„æ³¨é‡Šã€‚")
        print("="*50)

    except FileNotFoundError as e:
        print(f"\nâŒ æ–‡ä»¶è¯»å–é”™è¯¯: æœªæ‰¾åˆ°æ–‡ä»¶ã€‚\n{e}")
    except ValueError as e:
        print(f"\nâŒ åˆ—åæˆ–æ•°æ®å¼‚å¸¸: {e}")
    except Exception as e:
        print(f"\nâŒ å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}")

if __name__ == "__main__":
    fuzzy_policy_data_matching()